<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MafiaSun | Ø¨Ø§Ø²ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ */
        #main-game-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://s8.uupload.ir/files/img_20260208_152349_053_b8yg.jpg') no-repeat center center fixed;
            background-size: cover;
            display: block;
        }
        
        /* ØµÙØ­Ù‡ ØªØ§Ù„Ø§Ø± Ø¯ÙˆØ³ØªØ§Ù†Ù‡ */
        #friendly-hall-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://s8.uupload.ir/files/img_20260208_174730_422_inei.jpg') no-repeat center center fixed;
            background-size: cover;
            display: none;
        }
        
        /* ØµÙØ­Ù‡ Ù„Ø§Ø¨ÛŒ */
        #lobby-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0c3461 0%, #0d47a1 100%);
            display: none;
            overflow: hidden;
        }
        
        /* Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¯Ø± ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ */
        .profile-container {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 20px;
            border-radius: 25px;
            border: 2px solid #FF9800;
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.3s;
        }
        
        .profile-container:hover {
            transform: scale(1.05);
            background: rgba(0, 0, 0, 0.8);
        }
        
        .profile-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid white;
            background: transparent;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .profile-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .profile-name {
            color: white;
            font-family: sans-serif;
            font-size: 16px;
            font-weight: bold;
        }
        
        .profile-level {
            color: #FF9800;
            font-family: sans-serif;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 10px;
            border-radius: 10px;
            text-align: center;
        }
        
        /* Ù†ÙˆØ§Ø± Ø³ÛŒØ§Ù‡ Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ (ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ) */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 70px;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Ø¹Ú©Ø³ Ø®Ø§Ù†Ù‡ - Ø¨Ø¯ÙˆÙ† Ù‡ÛŒÚ† Ø­Ø§Ø´ÛŒÙ‡ ÛŒØ§ border */
        .house-img {
            width: 50px;
            height: 50px;
        }
        
        .house-img img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        /* Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹ (ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ) */
        .start-button {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            cursor: pointer;
            width: 180px;
            height: 180px;
        }
        
        .start-button img {
            width: 180px;
            height: 180px;
        }
        
        /* Ø¯Ú©Ù…Ù‡ Ø¶Ø±Ø¨Ø¯Ø± (ØµÙØ­Ù‡ ØªØ§Ù„Ø§Ø±) */
        .close-button {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 1000;
        }
        
        .close-button img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        /* Ø¯Ú©Ù…Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ù„Ø§Ø¨ÛŒ (ØµÙØ­Ù‡ ØªØ§Ù„Ø§Ø±) */
        .create-lobby-btn {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 60px;
            cursor: pointer;
        }
        
        .create-lobby-btn img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        /* Ù„ÛŒØ³Øª Ù„Ø§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ ØªØ§Ù„Ø§Ø± Ø¯ÙˆØ³ØªØ§Ù†Ù‡ */
        #lobbies-container {
            position: fixed;
            top: 100px;
            left: 20px;
            right: 20px;
            bottom: 180px;
            overflow-y: auto;
            display: none;
        }
        
        .lobby-card {
            background: linear-gradient(135deg, rgba(13, 71, 161, 0.9), rgba(21, 101, 192, 0.9));
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #FF9800;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .lobby-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .lobby-info {
            flex: 1;
        }
        
        .lobby-name {
            color: white;
            font-family: sans-serif;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .lobby-details {
            color: #E0E0E0;
            font-family: sans-serif;
            font-size: 14px;
        }
        
        .lobby-players {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .join-button {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: black;
            border: none;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        /* Ù…Ù†ÙˆÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù„Ø§Ø¨ÛŒ */
        .lobby-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #FF9800;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            display: none;
            z-index: 10000;
        }
        
        /* Ø¯Ú©Ù…Ù‡ Ø¶Ø±Ø¨Ø¯Ø± Ù…Ù†Ùˆ */
        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 25px;
            height: 25px;
            cursor: pointer;
        }
        
        .modal-close img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: invert(1);
        }
        
        /* ÙØ±Ù… Ø§ÛŒØ¬Ø§Ø¯ Ù„Ø§Ø¨ÛŒ */
        .lobby-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            color: white;
            font-family: sans-serif;
            font-size: 16px;
        }
        
        .form-group input {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #FF9800;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }
        
        .checkbox-group {
            flex-direction: row;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input {
            width: 20px;
            height: 20px;
        }
        
        /* Ø¯Ú©Ù…Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ù„Ø§Ø¨ÛŒ Ø¯Ø± Ù…Ù†Ùˆ */
        .create-btn {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: black;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s;
        }
        
        .create-btn:hover {
            transform: scale(1.05);
        }
        
        /* Ù…Ù†ÙˆÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ */
        .profile-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.97);
            border: 2px solid #FF9800;
            border-radius: 15px;
            padding: 0;
            width: 90%;
            max-width: 500px;
            display: none;
            z-index: 10001;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(255, 152, 0, 0.3);
        }
        
        .profile-modal-header {
            background: linear-gradient(135deg, #E65100, #BF360C);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #FF9800;
            position: relative;
        }
        
        .profile-modal-title {
            color: white;
            font-family: sans-serif;
            font-size: 22px;
            font-weight: bold;
        }
        
        /* Ø¯Ú©Ù…Ù‡ Ø¶Ø±Ø¨Ø¯Ø± Ø¯Ø± Ù…Ù†ÙˆÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ */
        .profile-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border: 2px solid white;
        }
        
        .profile-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .profile-modal-close::before, .profile-modal-close::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 2px;
            background: white;
        }
        
        .profile-modal-close::before {
            transform: rotate(45deg);
        }
        
        .profile-modal-close::after {
            transform: rotate(-45deg);
        }
        
        .profile-tabs {
            display: flex;
            background: rgba(255, 152, 0, 0.1);
            border-bottom: 1px solid #FF9800;
        }
        
        .profile-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            color: white;
            font-family: sans-serif;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .profile-tab.active {
            background: rgba(255, 152, 0, 0.2);
            border-bottom: 3px solid #FF9800;
            color: #FF9800;
        }
        
        .profile-tab-content {
            padding: 25px;
            display: none;
            min-height: 300px;
        }
        
        .profile-tab-content.active {
            display: block;
        }
        
        /* ØªØ¨ Ø¢ÙˆØ§ØªØ§Ø± Ù…Ù† */
        .avatars-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .avatar-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .avatar-item:hover {
            background: rgba(255, 152, 0, 0.1);
            transform: translateY(-5px);
        }
        
        .avatar-item.selected {
            border: 2px solid #FF9800;
            background: rgba(255, 152, 0, 0.15);
        }
        
        .avatar-preview {
            width: 100px;
            height: 100px;
            margin: 0 auto 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 3px solid white;
            background: transparent;
        }
        
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .avatar-name {
            color: white;
            font-family: sans-serif;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .avatar-select-btn {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: black;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s;
        }
        
        .avatar-select-btn:hover {
            transform: scale(1.05);
        }
        
        /* ØªØ¨ Ø®Ø±ÛŒØ¯ Ø¢ÙˆØ§ØªØ§Ø± */
        .coming-soon {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-family: sans-serif;
            font-size: 20px;
            margin-top: 100px;
        }
        
        /* Ù†ÙˆØ§Ø± ØªÛŒØ±Ù‡ ØªÛŒØ±Ù‡ Ù¾Ø§ÛŒÛŒÙ† Ø¯Ø± ØµÙØ­Ù‡ Ù„Ø§Ø¨ÛŒ */
        .dark-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 90px;
            background: rgba(5, 15, 30, 0.95);
            border-top: 2px solid #E65100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 10;
        }
        
        /* Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† */
        .players-container {
            position: fixed;
            bottom: 110px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 5;
            padding: 0 20px;
        }
        
        /* Ø³Ø§Ø®ØªØ§Ø± Ø¯Ùˆ Ø³ØªÙˆÙ†ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ */
        .circles-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px 120px;
            width: 100%;
            max-width: 600px;
        }
        
        /* Ø¯Ø§ÛŒØ±Ù‡ Ø¨Ø§Ø²ÛŒÚ©Ù† */
        .player-circle {
            width: 85px;
            height: 85px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        /* Ø¢ÙˆØ§ØªØ§Ø± Ø¨Ø²Ø±Ú¯ Ø¯Ø§Ø®Ù„ Ø¯Ø§ÛŒØ±Ù‡ */
        .player-avatar {
            width: 85px;
            height: 85px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 3px solid #E65100;
            background: linear-gradient(135deg, #0c3461, #0d47a1);
        }
        
        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        /* Ø´Ù…Ø§Ø±Ù‡ Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¯Ø± Ú©Ù†Ø§Ø± Ø¯Ø§ÛŒØ±Ù‡ */
        .player-number {
            position: absolute;
            top: -5px;
            right: -10px;
            background: #E65100;
            color: white;
            font-family: sans-serif;
            font-size: 14px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 50%;
            min-width: 28px;
            height: 28px;
            text-align: center;
            z-index: 10;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        /* Ø³ØªÙˆÙ† Ø³Ù…Øª Ø±Ø§Ø³Øª */
        .player-circle:nth-child(odd) {
            justify-self: end;
            margin-right: 10px;
        }
        
        /* Ø³ØªÙˆÙ† Ø³Ù…Øª Ú†Ù¾ */
        .player-circle:nth-child(even) {
            justify-self: start;
            margin-left: 10px;
        }
        
        /* Ø§Ø³Ù… Ø¨Ø§Ø²ÛŒÚ©Ù† Ø²ÛŒØ± Ø¯Ø§ÛŒØ±Ù‡ */
        .player-name {
            font-size: 12px;
            text-align: center;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: white;
            font-family: sans-serif;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.4);
            padding: 4px 10px;
            border-radius: 10px;
            margin-top: 8px;
        }
        
        /* Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ú©Ù†Ø§Ø± Ø¯Ø§ÛŒØ±Ù‡ */
        .player-icons {
            position: absolute;
            top: -5px;
            left: -10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 10;
        }
        
        .player-icon {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            animation: fadeIn 0.3s ease;
        }
        
        .like-icon {
            background: #4CAF50;
            color: white;
        }
        
        .dislike-icon {
            background: #F44336;
            color: white;
        }
        
        .mic-icon {
            background: #2196F3;
            color: white;
            animation: pulse 2s infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(33, 150, 243, 0); }
            100% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0); }
        }
        
        .like-icon.fade-out {
            animation: fadeOut 0.5s ease forwards;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.5); }
        }
        
        /* ÙˆØ¶Ø¹ÛŒØª Ø¢Ù†Ù„Ø§ÛŒÙ† */
        .online-status {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 12px;
            height: 12px;
            background: #4CAF50;
            border-radius: 50%;
            border: 2px solid white;
            z-index: 10;
        }
        
        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„ Ø¯Ø± Ù†ÙˆØ§Ø± Ù¾Ø§ÛŒÛŒÙ† */
        .control-buttons {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .control-btn {
            width: 70px;
            height: 70px;
            cursor: pointer;
            transition: transform 0.2s;
            background: transparent;
            border: none;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: brightness(1);
        }
        
        /* Ø¯Ú©Ù…Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø·Ø±Ø§Ø­ÛŒ Ø¬Ø¯ÛŒØ¯ Ùˆ Ø®ÙˆØ´Ú¯Ù„ */
        .mic-btn {
            background: linear-gradient(135deg, #666, #444);
            border-radius: 50%;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid #777;
        }
        
        .mic-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .mic-btn.active {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            border-color: #64B5F6;
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.5);
        }
        
        .mic-btn.active:hover {
            box-shadow: 0 6px 25px rgba(33, 150, 243, 0.6);
        }
        
        .mic-icon-design {
            position: relative;
            width: 35px;
            height: 35px;
            transition: all 0.3s ease;
        }
        
        .mic-base {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 18px;
            height: 10px;
            background: #FFF;
            border-radius: 3px;
            transition: all 0.3s ease;
        }
        
        .mic-stem {
            position: absolute;
            bottom: 11px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 15px;
            background: #FFF;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        
        .mic-head {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 22px;
            height: 22px;
            background: #FFF;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .mic-head::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 14px;
            height: 14px;
            background: #666;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .mic-btn.active .mic-base,
        .mic-btn.active .mic-stem,
        .mic-btn.active .mic-head {
            background: #FFF;
        }
        
        .mic-btn.active .mic-head::before {
            background: #2196F3;
        }
        
        .mic-off {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            width: 30px;
            height: 4px;
            background: #F44336;
            border-radius: 2px;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .mic-btn:not(.active) .mic-off {
            opacity: 1;
            background: #F44336;
        }
        
        .mic-btn:not(.active) .mic-base,
        .mic-btn:not(.active) .mic-stem,
        .mic-btn:not(.active) .mic-head {
            background: #AAA;
        }
        
        .mic-btn:not(.active) .mic-head::before {
            background: #777;
        }
        
        /* Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ø¯Ø± Ø³Ù…Øª Ú†Ù¾ */
        .start-game-btn {
            position: fixed;
            bottom: 35px;
            left: 25px;
            width: 100px;
            height: 100px;
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 11;
        }
        
        .start-game-btn:hover {
            transform: scale(1.05);
        }
        
        .start-game-btn img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }
        
        /* Ù†ÙˆØ§Ø± Ø¨Ø§Ù„Ø§ÛŒ Ù„Ø§Ø¨ÛŒ */
        .lobby-top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(135deg, #E65100, #BF360C);
            border-bottom: 2px solid #FF9800;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 1000;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }
        
        .lobby-title {
            color: white;
            font-family: sans-serif;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        /* Ø¶Ø±Ø¨Ø¯Ø± Ø¨Ø³ØªÙ† */
        .lobby-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            cursor: pointer;
            z-index: 1001;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border: 2px solid white;
        }
        
        .lobby-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .lobby-close::before, .lobby-close::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 2px;
            background: white;
        }
        
        .lobby-close::before {
            transform: rotate(45deg);
        }
        
        .lobby-close::after {
            transform: rotate(-45deg);
        }
        
        /* Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø§Ø³Ú©Ø±ÙˆÙ„Ø¨Ø§Ø± */
        body {
            overflow: hidden;
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÙˆÙ„Ø¨Ø§Ø± Ø¯Ø± ØªØ§Ù„Ø§Ø± */
        #lobbies-container::-webkit-scrollbar {
            width: 8px;
        }
        
        #lobbies-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        #lobbies-container::-webkit-scrollbar-thumb {
            background: #FF9800;
            border-radius: 4px;
        }
        
        .empty-state {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-family: sans-serif;
            font-size: 18px;
            margin-top: 50px;
        }
        
        /* Ø¢ÙˆØ§ØªØ§Ø± Ø®Ø§Ù„ÛŒ */
        .empty-avatar {
            font-size: 32px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± */
        .name-input-container {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .name-input-title {
            color: white;
            font-family: sans-serif;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .current-name {
            color: #FF9800;
            font-weight: bold;
        }
        
        .name-form {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .name-input {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #FF9800;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
        }
        
        .name-submit-btn {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: black;
            border: none;
            padding: 0 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
        }
        
        /* Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ */
        .player-joined-notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-family: sans-serif;
            font-size: 14px;
            font-weight: bold;
            z-index: 1002;
            animation: slideDown 0.5s ease, fadeOut 0.5s ease 2.5s forwards;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 2px solid white;
        }
        
        @keyframes slideDown {
            from { top: 50px; opacity: 0; }
            to { top: 80px; opacity: 1; }
        }
        
        /* ÙˆØ¶Ø¹ÛŒØª Ø³Ø§Ø²Ù†Ø¯Ù‡ */
        .creator-badge {
            position: absolute;
            top: -5px;
            left: -5px;
            background: #FF9800;
            color: black;
            font-family: sans-serif;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            z-index: 11;
            border: 1px solid white;
        }
        
        /* ÙˆØ¶Ø¹ÛŒØª Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¯Ø± Ø¯Ø§ÛŒØ±Ù‡ */
        .player-mic-status {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 20px;
            height: 20px;
            background: #2196F3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            z-index: 11;
            border: 1px solid white;
        }
        
        /* Ú†Øª Ù„Ø§Ø¨ÛŒ */
        .chat-container {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 300px;
            height: 300px;
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid #FF9800;
            border-radius: 10px;
            display: none;
            flex-direction: column;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .chat-header {
            background: linear-gradient(135deg, #E65100, #BF360C);
            padding: 10px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-title {
            color: white;
            font-family: sans-serif;
            font-weight: bold;
        }
        
        .chat-close {
            color: white;
            cursor: pointer;
            font-size: 20px;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .message {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 85%;
        }
        
        .message.sent {
            align-self: flex-end;
            background: rgba(33, 150, 243, 0.3);
            border: 1px solid #2196F3;
        }
        
        .message.received {
            align-self: flex-start;
            background: rgba(255, 152, 0, 0.3);
            border: 1px solid #FF9800;
        }
        
        .message-sender {
            font-weight: bold;
            color: #FF9800;
            font-size: 12px;
            margin-bottom: 2px;
        }
        
        .message-text {
            color: white;
            font-size: 14px;
        }
        
        .chat-input-container {
            display: flex;
            padding: 10px;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid #FF9800;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
        }
        
        .chat-send-btn {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: black;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Ø¯Ú©Ù…Ù‡ Ú†Øª */
        .chat-toggle-btn {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #FF9800, #F57C00);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
        }
        
        .chat-toggle-btn img {
            width: 24px;
            height: 24px;
            filter: brightness(0) invert(1);
        }
        
        /* Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø±Ù…Ø² */
        .password-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #FF9800;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 350px;
            z-index: 10002;
            display: none;
        }
        
        .password-title {
            color: white;
            font-family: sans-serif;
            font-size: 18px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .password-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #FF9800;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .password-buttons {
            display: flex;
            gap: 10px;
        }
        
        .password-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
        
        .password-submit {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }
        
        .password-cancel {
            background: linear-gradient(135deg, #F44336, #C62828);
            color: white;
        }
        
        /* Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ… */
        .system-message {
            position: fixed;
            top: 130px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(33, 150, 243, 0.9);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-family: sans-serif;
            font-size: 14px;
            z-index: 1002;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 2px solid white;
        }
        
        /* Video Grid */
        .video-grid {
            position: fixed;
            top: 70px;
            left: 20px;
            right: 20px;
            bottom: 200px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 2px solid #FF9800;
            z-index: 5;
        }
        
        .video-item {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .video-item video {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .video-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            font-size: 12px;
            text-align: center;
        }
        
        .video-local video {
            transform: rotateY(180deg);
        }
        
        /* ÙˆÛŒØ¯ÛŒÙˆÚ†Øª */
        .video-chat-container {
            position: fixed;
            top: 70px;
            left: 20px;
            right: 20px;
            bottom: 200px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 2px solid #FF9800;
            z-index: 5;
            padding: 15px;
            overflow: hidden;
        }
        
        .video-chat-title {
            color: white;
            font-family: sans-serif;
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
            background: rgba(255, 152, 0, 0.3);
            padding: 8px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ -->
    <div id="main-game-page">
        <!-- Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± -->
        <div class="profile-container" onclick="openProfileModal()">
            <div class="profile-avatar" id="mainProfileAvatar">
                <!-- Ø¢ÙˆØ§ØªØ§Ø± Ú©Ø§Ø±Ø¨Ø± -->
            </div>
            <div class="profile-info">
                <div class="profile-name" id="mainProfileName">Ø¨Ø§Ø²ÛŒÚ©Ù†</div>
                <div class="profile-level">Ø³Ø·Ø­ 1</div>
            </div>
        </div>
        
        <!-- Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹ -->
        <div class="start-button" onclick="openFriendlyHall()">
            <img src="https://s8.uupload.ir/files/inshot_20260208_175011014_dlkk.png" alt="Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ">
        </div>
        
        <!-- Ù†ÙˆØ§Ø± Ø³ÛŒØ§Ù‡ Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ -->
        <div class="bottom-bar">
            <div class="house-img">
                <img src="https://s8.uupload.ir/files/inshot_20260208_175045137_2eb2.png" alt="Ø®Ø§Ù†Ù‡">
            </div>
        </div>
    </div>
    
    <!-- ØµÙØ­Ù‡ ØªØ§Ù„Ø§Ø± Ø¯ÙˆØ³ØªØ§Ù†Ù‡ -->
    <div id="friendly-hall-page">
        <!-- Ø¯Ú©Ù…Ù‡ Ø¶Ø±Ø¨Ø¯Ø± Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª -->
        <div class="close-button" onclick="goBackToGame()">
            <img src="https://s8.uupload.ir/files/inshot_20260208_175500060_irk3.png" alt="Ø¨Ø§Ø²Ú¯Ø´Øª">
        </div>
        
        <!-- Ø¯Ú©Ù…Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ù„Ø§Ø¨ÛŒ -->
        <div class="create-lobby-btn" onclick="openLobbyModal()">
            <img src="https://s8.uupload.ir/files/inshot_20260208_184908314_wlkw.png" alt="Ø§ÛŒØ¬Ø§Ø¯ Ù„Ø§Ø¨ÛŒ">
        </div>
        
        <!-- Ù„ÛŒØ³Øª Ù„Ø§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ -->
        <div id="lobbies-container">
            <!-- Ù„Ø§Ø¨ÛŒâ€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯ÛŒÙ†Ø§Ù…ÛŒÚ© Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>
    </div>
    
    <!-- ØµÙØ­Ù‡ Ù„Ø§Ø¨ÛŒ -->
    <div id="lobby-page">
        <!-- Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ -->
        <div id="playerJoinedNotification" class="player-joined-notification" style="display: none;"></div>
        
        <!-- Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ… -->
        <div id="systemMessage" class="system-message" style="display: none;"></div>
        
        <!-- ÙˆÛŒØ¯ÛŒÙˆÚ†Øª -->
        <div class="video-chat-container" id="videoChatContainer" style="display: none;">
            <div class="video-chat-title">ğŸ¥ ÙˆÛŒØ¯ÛŒÙˆÚ†Øª Ù„Ø§Ø¨ÛŒ</div>
            <div class="video-grid" id="videoGrid">
                <!-- ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
            </div>
        </div>
        
        <!-- Ø¯Ú©Ù…Ù‡ Ú†Øª -->
        <div class="chat-toggle-btn" onclick="toggleChat()">
            ğŸ’¬
        </div>
        
        <!-- Ù¾Ù†Ø¬Ø±Ù‡ Ú†Øª -->
        <div class="chat-container" id="chatContainer">
            <div class="chat-header">
                <div class="chat-title">ğŸ’¬ Ú†Øª Ù„Ø§Ø¨ÛŒ</div>
                <div class="chat-close" onclick="toggleChat()">Ã—</div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">
                <button class="chat-send-btn" onclick="sendChatMessage()">Ø§Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
        
        <!-- Ù†ÙˆØ§Ø± Ø¨Ø§Ù„Ø§ÛŒ Ù„Ø§Ø¨ÛŒ -->
        <div class="lobby-top-bar">
            <div class="lobby-title" id="lobbyTitle">Ù†Ø§Ù… Ù„Ø§Ø¨ÛŒ</div>
            <!-- Ø¶Ø±Ø¨Ø¯Ø± Ø¨Ø³ØªÙ† -->
            <div class="lobby-close" onclick="closeLobby()"></div>
        </div>
        
        <!-- Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† -->
        <div class="players-container">
            <div class="circles-columns" id="playersGrid">
                <!-- Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯ÛŒÙ†Ø§Ù…ÛŒÚ© Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
            </div>
        </div>
        
        <!-- Ù†ÙˆØ§Ø± ØªÛŒØ±Ù‡ ØªÛŒØ±Ù‡ Ù¾Ø§ÛŒÛŒÙ† Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ -->
        <div class="dark-bottom-bar">
            <!-- Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ø¯Ø± Ø³Ù…Øª Ú†Ù¾ -->
            <div class="start-game-btn" onclick="startGame()">
                <img src="https://s8.uupload.ir/files/inshot_20260208_202015303_bu6y.png" alt="Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ">
            </div>
            
            <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„ Ø³Ù…Øª Ø±Ø§Ø³Øª -->
            <div class="control-buttons">
                <button class="control-btn like-btn" onclick="toggleLike()">
                    <img src="https://s8.uupload.ir/files/inshot_20260208_174410945_l9ef.png" alt="Ù„Ø§ÛŒÚ©">
                </button>
                <button class="control-btn dislike-btn" onclick="toggleDislike()">
                    <img src="https://s8.uupload.ir/files/inshot_20260208_174516362_oz8n.png" alt="Ø¯ÛŒØ³Ù„Ø§ÛŒÚ©">
                </button>
                <div class="mic-btn" id="micButton" onclick="toggleMic()">
                    <div class="mic-icon-design">
                        <div class="mic-base"></div>
                        <div class="mic-stem"></div>
                        <div class="mic-head"></div>
                        <div class="mic-off"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ù…Ù†ÙˆÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù„Ø§Ø¨ÛŒ -->
    <div class="lobby-modal" id="lobbyModal">
        <!-- Ø¯Ú©Ù…Ù‡ Ø¶Ø±Ø¨Ø¯Ø± Ù…Ù†Ùˆ -->
        <div class="modal-close" onclick="closeLobbyModal()">
            <img src="https://s8.uupload.ir/files/inshot_20260208_175500060_irk3.png" alt="Ø¨Ø³ØªÙ†">
        </div>
        
        <!-- ÙØ±Ù… Ø§ÛŒØ¬Ø§Ø¯ Ù„Ø§Ø¨ÛŒ -->
        <form class="lobby-form" id="lobbyForm" onsubmit="event.preventDefault(); createLobby();">
            <div class="form-group">
                <label for="lobbyName">Ø§Ø³Ù… Ù„Ø§Ø¨ÛŒ</label>
                <input type="text" id="lobbyName" placeholder="Ù…Ø«Ø§Ù„: Ù„Ø§Ø¨ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ" required>
            </div>
            
            <div class="form-group checkbox-group">
                <input type="checkbox" id="hasPassword" onclick="togglePasswordField()">
                <label for="hasPassword">Ù„Ø§Ø¨ÛŒ Ø±Ù…Ø²Ø¯Ø§Ø±</label>
            </div>
            
            <div class="form-group" id="passwordGroup" style="display: none;">
                <label for="lobbyPassword">Ø±Ù…Ø² Ù„Ø§Ø¨ÛŒ</label>
                <input type="password" id="lobbyPassword" placeholder="Ø±Ù…Ø² Ø¯Ù„Ø®ÙˆØ§Ù‡">
            </div>
            
            <div class="form-group">
                <label>Ù†Ù‚Ø´: ØªÚ©Ø§ÙˆØ± - Ø¸Ø±ÙÛŒØª: 10 Ù†ÙØ±</label>
            </div>
            
            <button type="submit" class="create-btn">Ø§ÛŒØ¬Ø§Ø¯ Ù„Ø§Ø¨ÛŒ</button>
        </form>
    </div>
    
    <!-- Ù…Ù†ÙˆÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-modal-header">
            <div class="profile-modal-title">Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±</div>
            <!-- Ø¶Ø±Ø¨Ø¯Ø± Ø¨Ø³ØªÙ† -->
            <div class="profile-modal-close" onclick="closeProfileModal()"></div>
        </div>
        
        <div class="profile-tabs">
            <div class="profile-tab active" onclick="switchProfileTab('avatars')">Ø¢ÙˆØ§ØªØ§Ø± Ù…Ù†</div>
            <div class="profile-tab" onclick="switchProfileTab('buy')">Ø®Ø±ÛŒØ¯ Ø¢ÙˆØ§ØªØ§Ø±</div>
        </div>
        
        <!-- ØªØ¨ Ø¢ÙˆØ§ØªØ§Ø± Ù…Ù† -->
        <div class="profile-tab-content active" id="avatarsTab">
            <h3 style="color: white; font-family: sans-serif; text-align: center; margin-bottom: 20px;">Ø¢ÙˆØ§ØªØ§Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</h3>
            
            <div class="avatars-container">
                <!-- Ø¢ÙˆØ§ØªØ§Ø± 1 -->
                <div class="avatar-item" id="avatar1" onclick="selectAvatar('avatar1')">
                    <div class="avatar-preview">
                        <img src="https://s8.uupload.ir/files/inshot_20260208_214035107_wkwk.png" alt="Ø¢ÙˆØ§ØªØ§Ø± 1">
                    </div>
                    <div class="avatar-name">Ø¢ÙˆØ§ØªØ§Ø± Ù…Ø±Ø¯</div>
                    <button class="avatar-select-btn" onclick="selectAvatar('avatar1'); event.stopPropagation();">Ø§Ù†ØªØ®Ø§Ø¨</button>
                </div>
                
                <!-- Ø¢ÙˆØ§ØªØ§Ø± 2 -->
                <div class="avatar-item" id="avatar2" onclick="selectAvatar('avatar2')">
                    <div class="avatar-preview">
                        <img src="https://s8.uupload.ir/files/inshot_20260208_214116629_6joe.png" alt="Ø¢ÙˆØ§ØªØ§Ø± 2">
                    </div>
                    <div class="avatar-name">Ø¢ÙˆØ§ØªØ§Ø± Ø²Ù†</div>
                    <button class="avatar-select-btn" onclick="selectAvatar('avatar2'); event.stopPropagation();">Ø§Ù†ØªØ®Ø§Ø¨</button>
                </div>
            </div>
            
            <!-- ØªÙ†Ø¸ÛŒÙ… Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± -->
            <div class="name-input-container">
                <div class="name-input-title">
                    Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙØ¹Ù„ÛŒ: <span class="current-name" id="currentUserName">Ø¨Ø§Ø²ÛŒÚ©Ù†</span>
                </div>
                <div class="name-form">
                    <input type="text" class="name-input" id="userNameInput" placeholder="Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
                    <button class="name-submit-btn" onclick="saveUserName()">ØªØºÛŒÛŒØ±</button>
                </div>
            </div>
        </div>
        
        <!-- ØªØ¨ Ø®Ø±ÛŒØ¯ Ø¢ÙˆØ§ØªØ§Ø± -->
        <div class="profile-tab-content" id="buyTab">
            <div class="coming-soon">Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ...</div>
        </div>
    </div>
    
    <!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø±Ù…Ø² -->
    <div class="password-popup" id="passwordPopup">
        <div class="password-title">ğŸ”’ Ù„Ø§Ø¨ÛŒ Ø±Ù…Ø²Ø¯Ø§Ø± Ø§Ø³Øª</div>
        <input type="password" class="password-input" id="passwordInput" placeholder="Ø±Ù…Ø² Ù„Ø§Ø¨ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
        <div class="password-buttons">
            <button class="password-btn password-submit" onclick="submitPassword()">ÙˆØ±ÙˆØ¯</button>
            <button class="password-btn password-cancel" onclick="cancelPassword()">Ù„ØºÙˆ</button>
        </div>
    </div>

    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        // ==================== ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø±ÙˆØ± ====================
        const SERVER_URL = 'https://mafia-server.iran.liara.run';
        
        // ==================== Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ====================
        let lobbies = [];
        let currentLobby = null;
        let userLiked = false;
        let userDisliked = false;
        let userMicOn = false;
        let currentAvatar = 'avatar1';
        let userName = 'Ø¨Ø§Ø²ÛŒÚ©Ù†';
        let playerStates = {};
        let likeTimeouts = {};
        let currentUser = null;
        let currentSeat = null;
        let isCreator = false;
        let chatMessages = [];
        let socket = null;
        let peer = null;
        let localStream = null;
        let peerConnections = {};
        let pendingPasswordLobby = null;
        
        // ==================== Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± ====================
        function connectToServer() {
            console.log('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±...');
            
            socket = io(SERVER_URL, {
                transports: ['websocket', 'polling'],
                auth: {
                    token: 'mafia2024_secret_token',
                    userId: currentUser,
                    username: userName
                }
            });
            
            socket.on('connect', () => {
                console.log('âœ… Ø¨Ù‡ Ø³Ø±ÙˆØ± Ù…ØªØµÙ„ Ø´Ø¯ÛŒØ¯');
                showSystemMessage('Ø¨Ù‡ Ø³Ø±ÙˆØ± Ù…ØªØµÙ„ Ø´Ø¯ÛŒØ¯', 'success');
                
                // Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ù„Ø§Ø¨ÛŒâ€ŒÙ‡Ø§
                socket.emit('get-lobbies');
            });
            
            socket.on('disconnect', () => {
                console.log('âŒ Ø§Ø² Ø³Ø±ÙˆØ± Ù‚Ø·Ø¹ Ø´Ø¯ÛŒØ¯');
                showSystemMessage('Ø§Ø² Ø³Ø±ÙˆØ± Ù‚Ø·Ø¹ Ø´Ø¯ÛŒØ¯', 'error');
            });
            
            socket.on('connect_error', (error) => {
                console.error('âŒ Ø®Ø·Ø§ÛŒ Ø§ØªØµØ§Ù„:', error);
                showSystemMessage('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±', 'error');
            });
            
            // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø³Ø±ÙˆØ±
            setupSocketEvents();
            
            // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ PeerJS Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ¯ÛŒÙˆÚ†Øª
            setupPeerConnection();
        }
        
        function setupSocketEvents() {
            // Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ù„Ø§Ø¨ÛŒâ€ŒÙ‡Ø§
            socket.on('lobby-list', (serverLobbies) => {
                console.log('ğŸ“‹ Ù„ÛŒØ³Øª Ù„Ø§Ø¨ÛŒâ€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯:', serverLobbies.length);
                lobbies = serverLobbies;
                updateLobbiesList();
            });
            
            // Ù„Ø§Ø¨ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯
            socket.on('lobby-created', (lobby) => {
                console.log('âœ… Ù„Ø§Ø¨ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯:', lobby.name);
                showSystemMessage(`Ù„Ø§Ø¨ÛŒ "${lobby.name}" Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`, 'success');
                
                // ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù„Ø§Ø¨ÛŒ
                currentLobby = lobby;
                enterLobby(lobby);
            });
            
            // ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù„Ø§Ø¨ÛŒ
            socket.on('lobby-joined', (lobby) => {
                console.log('ğŸšª Ø¨Ù‡ Ù„Ø§Ø¨ÛŒ ÙˆØ§Ø±Ø¯ Ø´Ø¯ÛŒØ¯:', lobby.name);
                currentLobby = lobby;
                playerStates = lobby.players || {};
                enterLobby(lobby);
                
                // Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
                showPlayerJoinedNotification(`${userName} ÙˆØ§Ø±Ø¯ Ù„Ø§Ø¨ÛŒ Ø´Ø¯`);
            });
            
            // Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø´Ø¯
            socket.on('user-joined', (data) => {
                console.log('ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø´Ø¯:', data.username);
                if (currentLobby && currentLobby.id === data.lobbyId) {
                    showPlayerJoinedNotification(`${data.username} ÙˆØ§Ø±Ø¯ Ù„Ø§Ø¨ÛŒ Ø´Ø¯`);
                    
                    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†
                    socket.emit('get-lobby', currentLobby.id);
                    
                    // Ø´Ø±ÙˆØ¹ ÙˆÛŒØ¯ÛŒÙˆÚ†Øª Ø¨Ø§ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                    if (peer && data.userId !== currentUser) {
                        startVideoCall(data.userId);
                    }
                }
            });
            
            // Ú©Ø§Ø±Ø¨Ø± Ø®Ø§Ø±Ø¬ Ø´Ø¯
            socket.on('user-left', (data) => {
                console.log('ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø± Ø®Ø§Ø±Ø¬ Ø´Ø¯:', data.username);
                if (currentLobby && currentLobby.id === data.lobbyId) {
                    showSystemMessage(`${data.username} Ø§Ø² Ù„Ø§Ø¨ÛŒ Ø®Ø§Ø±Ø¬ Ø´Ø¯`, 'info');
                    
                    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†
                    socket.emit('get-lobby', currentLobby.id);
                    
                    // Ù‚Ø·Ø¹ ÙˆÛŒØ¯ÛŒÙˆÚ†Øª
                    if (peerConnections[data.userId]) {
                        peerConnections[data.userId].close();
                        delete peerConnections[data.userId];
                        removeVideoStream(data.userId);
                    }
                }
            });
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„Ø§Ø¨ÛŒ
            socket.on('lobby-updated', (lobby) => {
                if (currentLobby && currentLobby.id === lobby.id) {
                    console.log('ğŸ”„ Ù„Ø§Ø¨ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯');
                    currentLobby = lobby;
                    playerStates = lobby.players || {};
                    updateLobbyDisplay();
                }
            });
            
            // Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù… Ú†Øª
            socket.on('chat-message', (message) => {
                console.log('ğŸ’¬ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯:', message);
                if (currentLobby && currentLobby.id === message.lobbyId) {
                    const isSelf = message.userId === currentUser;
                    addChatMessage(message.username, message.text, isSelf ? 'sent' : 'received');
                }
            });
            
            // Ø¯Ø±ÛŒØ§ÙØª Ø³ÛŒØ³ØªÙ… Ù¾ÛŒØ§Ù…
            socket.on('system-message', (data) => {
                if (currentLobby && currentLobby.id === data.lobbyId) {
                    showSystemMessage(data.message, 'info');
                    addChatMessage('Ø³ÛŒØ³ØªÙ…', data.message, 'system');
                }
            });
            
            // WebRTC signaling
            socket.on('video-offer', async (data) => {
                if (data.to === currentUser) {
                    console.log('ğŸ“¹ Ø¯Ø±ÛŒØ§ÙØª offer ÙˆÛŒØ¯ÛŒÙˆ Ø§Ø²:', data.from);
                    await handleVideoOffer(data.offer, data.from);
                }
            });
            
            socket.on('video-answer', (data) => {
                if (data.to === currentUser) {
                    console.log('ğŸ“¹ Ø¯Ø±ÛŒØ§ÙØª answer ÙˆÛŒØ¯ÛŒÙˆ Ø§Ø²:', data.from);
                    handleVideoAnswer(data.answer, data.from);
                }
            });
            
            socket.on('ice-candidate', (data) => {
                if (data.to === currentUser) {
                    console.log('â„ï¸ Ø¯Ø±ÛŒØ§ÙØª ICE candidate Ø§Ø²:', data.from);
                    handleICECandidate(data.candidate, data.from);
                }
            });
        }
        
        function setupPeerConnection() {
            if (!currentUser) return;
            
            peer = new Peer(currentUser, {
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                debug: 2
            });
            
            peer.on('open', (id) => {
                console.log('âœ… PeerJS Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª. ID:', id);
            });
            
            peer.on('error', (err) => {
                console.error('âŒ Ø®Ø·Ø§ÛŒ PeerJS:', err);
            });
            
            peer.on('call', async (call) => {
                console.log('ğŸ“ Ø¯Ø±ÛŒØ§ÙØª ØªÙ…Ø§Ø³ ÙˆÛŒØ¯ÛŒÙˆÛŒÛŒ Ø§Ø²:', call.peer);
                
                if (!localStream) {
                    try {
                        localStream = await navigator.mediaDevices.getUserMedia({
                            video: true,
                            audio: true
                        });
                        setupLocalVideo();
                    } catch (err) {
                        console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ†:', err);
                        return;
                    }
                }
                
                call.answer(localStream);
                
                call.on('stream', (remoteStream) => {
                    console.log('ğŸ¥ Ø¯Ø±ÛŒØ§ÙØª stream Ø§Ø²:', call.peer);
                    addVideoStream(call.peer, remoteStream);
                });
                
                call.on('close', () => {
                    console.log('ğŸ“ ØªÙ…Ø§Ø³ ÙˆÛŒØ¯ÛŒÙˆÛŒÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯:', call.peer);
                    removeVideoStream(call.peer);
                });
            });
            
            peer.on('connection', (conn) => {
                console.log('ğŸ”— Ø§ØªØµØ§Ù„ Ø¯Ø§Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯:', conn.peer);
                conn.on('data', (data) => {
                    console.log('ğŸ“© Ø¯Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯:', data);
                });
            });
        }
        
        // ==================== Ø³ÛŒØ³ØªÙ… Ú©Ø§Ø±Ø¨Ø± ====================
        function loadUserData() {
            const savedAvatar = localStorage.getItem('mafiaUserAvatar');
            const savedName = localStorage.getItem('mafiaUserName');
            const savedId = localStorage.getItem('mafiaUserId');
            
            if (savedAvatar) currentAvatar = savedAvatar;
            if (savedName) userName = savedName;
            
            if (savedId) {
                currentUser = savedId;
            } else {
                currentUser = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('mafiaUserId', currentUser);
            }
            
            updateMainProfile();
            
            // Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
            connectToServer();
        }
        
        function updateMainProfile() {
            const profileAvatar = document.getElementById('mainProfileAvatar');
            const profileName = document.getElementById('mainProfileName');
            
            profileAvatar.innerHTML = '';
            const avatarImg = document.createElement('img');
            avatarImg.src = currentAvatar === 'avatar1' 
                ? 'https://s8.uupload.ir/files/inshot_20260208_214035107_wkwk.png'
                : 'https://s8.uupload.ir/files/inshot_20260208_214116629_6joe.png';
            avatarImg.alt = 'Ø¢ÙˆØ§ØªØ§Ø± Ú©Ø§Ø±Ø¨Ø±';
            profileAvatar.appendChild(avatarImg);
            profileName.textContent = userName;
        }
        
        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª ØµÙØ­Ø§Øª ====================
        function openFriendlyHall() {
            document.getElementById('main-game-page').style.display = 'none';
            document.getElementById('friendly-hall-page').style.display = 'block';
            
            // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù„ÛŒØ³Øª Ù„Ø§Ø¨ÛŒâ€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ±
            if (socket) {
                socket.emit('get-lobbies');
            }
        }
        
        function goBackToGame() {
            document.getElementById('friendly-hall-page').style.display = 'none';
            document.getElementById('main-game-page').style.display = 'block';
        }
        
        // ==================== Ø³ÛŒØ³ØªÙ… Ù„Ø§Ø¨ÛŒ ====================
        function updateLobbiesList() {
            const container = document.getElementById('lobbies-container');
            
            console.log('ğŸ“‹ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ù„Ø§Ø¨ÛŒâ€ŒÙ‡Ø§. ØªØ¹Ø¯Ø§Ø¯:', lobbies.length);
            
            if (lobbies.length === 0) {
                container.innerHTML = '<div class="empty-state">Ù‡ÛŒÚ† Ù„Ø§Ø¨ÛŒâ€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª<br>Ø§ÙˆÙ„ÛŒÙ† Ù„Ø§Ø¨ÛŒ Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯!</div>';
                container.style.display = 'block';
                return;
            }
            
            let html = '';
            let displayedLobbies = 0;
            
            // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ù„Ø§Ø¨ÛŒâ€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù†
            const sortedLobbies = [...lobbies].sort((a, b) => {
                const playersA = Object.keys(a.players || {}).length;
                const playersB = Object.keys(b.players || {}).length;
                return playersB - playersA;
            });
            
            sortedLobbies.forEach(lobby => {
                const players = Object.values(lobby.players || {}).length;
                const maxPlayers = lobby.maxPlayers || 10;
                
                if (players >= maxPlayers) return;
                
                html += `
                    <div class="lobby-card" onclick="requestJoinLobby('${lobby.id}')">
                        <div class="lobby-info">
                            <div class="lobby-name">${lobby.name}</div>
                            <div class="lobby-details">
                                Ø³Ø§Ø²Ù†Ø¯Ù‡: ${lobby.creatorName || 'Ù†Ø§Ù…Ø´Ø®Øµ'} | 
                                Ù†Ù‚Ø´: ØªÚ©Ø§ÙˆØ± | 
                                <span class="lobby-players">${players}/${maxPlayers}</span> Ù†ÙØ±
                                ${lobby.hasPassword ? ' | ğŸ” Ø±Ù…Ø²Ø¯Ø§Ø±' : ''}
                            </div>
                        </div>
                        <button class="join-button" onclick="requestJoinLobby('${lobby.id}'); event.stopPropagation();">
                            ÙˆØ±ÙˆØ¯
                        </button>
                    </div>
                `;
                
                displayedLobbies++;
            });
            
            console.log('âœ… ØªØ¹Ø¯Ø§Ø¯ Ù„Ø§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡:', displayedLobbies);
            
            if (displayedLobbies === 0) {
                html = '<div class="empty-state">Ù‡ÛŒÚ† Ù„Ø§Ø¨ÛŒ ÙØ¹Ø§Ù„ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª<br>Ø§ÙˆÙ„ÛŒÙ† Ù„Ø§Ø¨ÛŒ Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯!</div>';
            }
            
            container.innerHTML = html;
            container.style.display = 'block';
        }
        
        function openLobbyModal() {
            document.getElementById('lobbyModal').style.display = 'block';
            document.getElementById('lobbyName').focus();
        }
        
        function closeLobbyModal() {
            document.getElementById('lobbyModal').style.display = 'none';
            document.getElementById('lobbyForm').reset();
            document.getElementById('passwordGroup').style.display = 'none';
        }
        
        function togglePasswordField() {
            const passwordGroup = document.getElementById('passwordGroup');
            const hasPassword = document.getElementById('hasPassword').checked;
            passwordGroup.style.display = hasPassword ? 'flex' : 'none';
        }
        
        // ==================== Ø§ÛŒØ¬Ø§Ø¯ Ù„Ø§Ø¨ÛŒ Ø¬Ø¯ÛŒØ¯ ====================
        async function createLobby() {
            const lobbyName = document.getElementById('lobbyName').value.trim();
            const hasPassword = document.getElementById('hasPassword').checked;
            const lobbyPassword = document.getElementById('lobbyPassword').value;
            
            if (!lobbyName) {
                showSystemMessage('Ù„Ø·ÙØ§ Ø§Ø³Ù… Ù„Ø§Ø¨ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            if (hasPassword && !lobbyPassword) {
                showSystemMessage('Ù„Ø·ÙØ§ Ø±Ù…Ø² Ù„Ø§Ø¨ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            console.log('ğŸš€ Ø§ÛŒØ¬Ø§Ø¯ Ù„Ø§Ø¨ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù†Ø§Ù…:', lobbyName);
            
            if (socket) {
                socket.emit('create-lobby', {
                    name: lobbyName,
                    hasPassword: hasPassword,
                    password: hasPassword ? lobbyPassword : null,
                    maxPlayers: 10,
                    creatorId: currentUser,
                    creatorName: userName,
                    creatorAvatar: currentAvatar
                });
            }
            
            closeLobbyModal();
        }
        
        // ==================== ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù„Ø§Ø¨ÛŒ ====================
        function requestJoinLobby(lobbyId) {
            console.log('ğŸ” Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù„Ø§Ø¨ÛŒ:', lobbyId);
            
            const lobby = lobbies.find(l => l.id === lobbyId);
            if (!lobby) {
                showSystemMessage('Ù„Ø§Ø¨ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯!', 'error');
                return;
            }
            
            console.log('âœ… Ù„Ø§Ø¨ÛŒ Ù¾ÛŒØ¯Ø§ Ø´Ø¯:', lobby.name);
            
            // Ø§Ú¯Ø± Ù„Ø§Ø¨ÛŒ Ø±Ù…Ø²Ø¯Ø§Ø± Ø§Ø³Øª
            if (lobby.hasPassword) {
                pendingPasswordLobby = lobby;
                showPasswordPopup();
            } else {
                joinLobby(lobbyId, null);
            }
        }
        
        function showPasswordPopup() {
            document.getElementById('passwordPopup').style.display = 'block';
            document.getElementById('passwordInput').focus();
        }
        
        function submitPassword() {
            const password = document.getElementById('passwordInput').value;
            
            if (!pendingPasswordLobby) return;
            
            joinLobby(pendingPasswordLobby.id, password);
            document.getElementById('passwordPopup').style.display = 'none';
            document.getElementById('passwordInput').value = '';
            pendingPasswordLobby = null;
        }
        
        function cancelPassword() {
            document.getElementById('passwordPopup').style.display = 'none';
            document.getElementById('passwordInput').value = '';
            pendingPasswordLobby = null;
        }
        
        function joinLobby(lobbyId, password) {
            console.log('ğŸšª Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù„Ø§Ø¨ÛŒ:', lobbyId);
            
            if (socket) {
                socket.emit('join-lobby', {
                    lobbyId: lobbyId,
                    password: password
                });
            }
        }
        
        function enterLobby(lobby) {
            console.log('ğŸšª ÙˆØ±ÙˆØ¯ Ø¨Ù‡ ØµÙØ­Ù‡ Ù„Ø§Ø¨ÛŒ:', lobby.name);
            
            currentLobby = lobby;
            playerStates = lobby.players || {};
            chatMessages = lobby.chat || [];
            
            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Ø®ÙˆØ¯Ù…Ø§Ù†
            currentSeat = null;
            isCreator = false;
            
            Object.entries(playerStates).forEach(([seat, player]) => {
                if (player && player.userId === currentUser) {
                    currentSeat = parseInt(seat);
                    isCreator = (lobby.creatorId === currentUser);
                }
            });
            
            console.log('âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù„Ø§Ø¨ÛŒ: Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Ø´Ù…Ø§:', currentSeat, 'Ø³Ø§Ø²Ù†Ø¯Ù‡ Ù‡Ø³ØªÛŒØ¯ØŸ', isCreator);
            
            // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ù„Ø§Ø¨ÛŒ
            document.getElementById('friendly-hall-page').style.display = 'none';
            document.getElementById('lobby-page').style.display = 'block';
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´
            updateLobbyDisplay();
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú†Øª
            loadChatMessages();
            
            // Ø´Ø±ÙˆØ¹ ÙˆÛŒØ¯ÛŒÙˆÚ†Øª
            startVideoChat();
            
            console.log(`âœ… ÙˆØ§Ø±Ø¯ Ù„Ø§Ø¨ÛŒ Ø´Ø¯ÛŒØ¯: ${lobby.name}`);
        }
        
        function showPlayerJoinedNotification(message) {
            const notification = document.getElementById('playerJoinedNotification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function showSystemMessage(message, type = 'info') {
            const systemMessage = document.getElementById('systemMessage');
            systemMessage.textContent = message;
            
            if (type === 'error') {
                systemMessage.style.backgroundColor = 'rgba(244, 67, 54, 0.9)';
            } else if (type === 'success') {
                systemMessage.style.backgroundColor = 'rgba(76, 175, 80, 0.9)';
            } else {
                systemMessage.style.backgroundColor = 'rgba(33, 150, 243, 0.9)';
            }
            
            systemMessage.style.display = 'block';
            
            setTimeout(() => {
                systemMessage.style.display = 'none';
            }, 3000);
        }
        
        // ==================== Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† ====================
        function createPlayerCircles() {
            const container = document.getElementById('playersGrid');
            if (!container || !currentLobby) return;
            
            let html = '';
            const maxPlayers = currentLobby.maxPlayers || 10;
            
            for (let i = 1; i <= maxPlayers; i++) {
                const playerData = playerStates[i];
                
                if (playerData) {
                    // Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
                    let iconsHtml = '';
                    if (playerData.like) {
                        iconsHtml += '<div class="player-icon like-icon">ğŸ‘</div>';
                    }
                    if (playerData.dislike) {
                        iconsHtml += '<div class="player-icon dislike-icon">ğŸ‘</div>';
                    }
                    
                    // Ù†Ø´Ø§Ù†â€ŒÚ¯Ø± Ø³Ø§Ø²Ù†Ø¯Ù‡
                    const isPlayerCreator = (currentLobby.creatorId === playerData.userId);
                    
                    html += `
                        <div class="player-circle" data-player="${i}">
                            ${isPlayerCreator ? '<div class="creator-badge">Ø³Ø§Ø²Ù†Ø¯Ù‡</div>' : ''}
                            <div class="player-number">${i}</div>
                            <div class="online-status"></div>
                            ${iconsHtml ? `<div class="player-icons">${iconsHtml}</div>` : ''}
                            ${playerData.mic ? '<div class="player-mic-status">ğŸ¤</div>' : ''}
                            <div class="player-avatar">
                                <img src="${playerData.avatar === 'avatar1' 
                                    ? 'https://s8.uupload.ir/files/inshot_20260208_214035107_wkwk.png'
                                    : 'https://s8.uupload.ir/files/inshot_20260208_214116629_6joe.png'}" 
                                    alt="Ø¢ÙˆØ§ØªØ§Ø± ${playerData.name}">
                            </div>
                            <div class="player-name">
                                ${playerData.name}
                                ${playerData.userId === currentUser ? ' (Ø´Ù…Ø§)' : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Ø®Ø§Ù„ÛŒ
                    html += `
                        <div class="player-circle" data-player="${i}">
                            <div class="player-number">${i}</div>
                            <div class="player-avatar">
                                <div class="empty-avatar">+</div>
                            </div>
                            <div class="player-name">Ø®Ø§Ù„ÛŒ</div>
                        </div>
                    `;
                }
            }
            
            container.innerHTML = html;
        }
        
        function updateLobbyDisplay() {
            if (!currentLobby) return;
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¹Ù†ÙˆØ§Ù†
            const onlinePlayers = Object.values(playerStates).filter(p => p).length;
            document.getElementById('lobbyTitle').textContent = 
                `${currentLobby.name} (${onlinePlayers}/${currentLobby.maxPlayers})`;
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†
            createPlayerCircles();
        }
        
        // ==================== Ø®Ø±ÙˆØ¬ Ø§Ø² Ù„Ø§Ø¨ÛŒ ====================
        function closeLobby() {
            if (!currentLobby) return;
            
            console.log('ğŸšª Ø®Ø±ÙˆØ¬ Ø§Ø² Ù„Ø§Ø¨ÛŒ:', currentLobby.name);
            
            if (socket) {
                socket.emit('leave-lobby', { lobbyId: currentLobby.id });
            }
            
            // Ù‚Ø·Ø¹ ØªÙ…Ø§Ù… Ø§ØªØµØ§Ù„Ø§Øª ÙˆÛŒØ¯ÛŒÙˆÛŒÛŒ
            Object.keys(peerConnections).forEach(userId => {
                if (peerConnections[userId]) {
                    peerConnections[userId].close();
                }
            });
            peerConnections = {};
            
            // Ù…ØªÙˆÙ‚Ù Ú©Ø±Ø¯Ù† Ø§Ø³ØªØ±ÛŒÙ… Ù…Ø­Ù„ÛŒ
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§
            document.getElementById('videoGrid').innerHTML = '';
            document.getElementById('videoChatContainer').style.display = 'none';
            
            // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ ØªØ§Ù„Ø§Ø±
            document.getElementById('lobby-page').style.display = 'none';
            document.getElementById('friendly-hall-page').style.display = 'block';
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ù„Ø§Ø¨ÛŒâ€ŒÙ‡Ø§
            if (socket) {
                socket.emit('get-lobbies');
            }
            
            // Ø±ÛŒØ³Øª Ù…ØªØºÛŒØ±Ù‡Ø§
            currentLobby = null;
            currentSeat = null;
            isCreator = false;
            playerStates = {};
            userMicOn = false;
            
            console.log('âœ… Ø¨Ù‡ ØµÙØ­Ù‡ ØªØ§Ù„Ø§Ø± Ø¯ÙˆØ³ØªØ§Ù†Ù‡ Ø¨Ø§Ø²Ú¯Ø´ØªÛŒØ¯');
        }
        
        // ==================== Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ ====================
        function startGame() {
            if (!currentLobby) return;
            
            // ÙÙ‚Ø· Ø³Ø§Ø²Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø§Ø²ÛŒ Ø±Ø§ Ø´Ø±ÙˆØ¹ Ú©Ù†Ø¯
            if (!isCreator) {
                showSystemMessage('ÙÙ‚Ø· Ø³Ø§Ø²Ù†Ø¯Ù‡ Ù„Ø§Ø¨ÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø§Ø²ÛŒ Ø±Ø§ Ø´Ø±ÙˆØ¹ Ú©Ù†Ø¯!', 'error');
                return;
            }
            
            const onlinePlayers = Object.values(playerStates).filter(p => p).length;
            if (onlinePlayers < 4) {
                showSystemMessage('Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ø­Ø¯Ø§Ù‚Ù„ Û´ Ø¨Ø§Ø²ÛŒÚ©Ù† Ù„Ø§Ø²Ù… Ø§Ø³Øª!', 'error');
                return;
            }
            
            if (socket) {
                socket.emit('start-game', { lobbyId: currentLobby.id });
            }
            
            showSystemMessage('ğŸ® Ø¨Ø§Ø²ÛŒ Ø´Ø±ÙˆØ¹ Ø´Ø¯!', 'success');
        }
        
        // ==================== Ø³ÛŒØ³ØªÙ… Ú†Øª ====================
        function toggleChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.style.display = chatContainer.style.display === 'flex' ? 'none' : 'flex';
            
            if (chatContainer.style.display === 'flex') {
                setTimeout(() => {
                    const chatMessages = document.getElementById('chatMessages');
                    if (chatMessages) {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                }, 100);
            }
        }
        
        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message || !currentLobby) return;
            
            if (socket) {
                socket.emit('send-chat', {
                    lobbyId: currentLobby.id,
                    message: message
                });
            }
            
            addChatMessage(userName, message, 'sent');
            chatInput.value = '';
        }
        
        function loadChatMessages() {
            const chatMessagesContainer = document.getElementById('chatMessages');
            if (!chatMessagesContainer || !currentLobby || !currentLobby.chat) return;
            
            chatMessagesContainer.innerHTML = '';
            chatMessages = currentLobby.chat || [];
            
            chatMessages.forEach(message => {
                const type = message.userId === currentUser ? 'sent' : 'received';
                addChatMessage(message.username, message.text, type);
            });
        }
        
        function addChatMessage(sender, text, type) {
            const chatMessagesContainer = document.getElementById('chatMessages');
            if (!chatMessagesContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            let senderText = sender;
            if (type === 'system') {
                senderText = 'ğŸ“¢ ' + sender;
            } else if (type === 'sent') {
                senderText = 'ğŸ‘¤ Ø´Ù…Ø§';
            } else {
                senderText = 'ğŸ‘¤ ' + sender;
            }
            
            messageDiv.innerHTML = `
                <div class="message-sender">${senderText}</div>
                <div class="message-text">${text}</div>
            `;
            
            chatMessagesContainer.appendChild(messageDiv);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }
        
        // ==================== Ø³ÛŒØ³ØªÙ… Ù„Ø§ÛŒÚ©/Ø¯ÛŒØ³Ù„Ø§ÛŒÚ©/Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† ====================
        function toggleLike() {
            if (!currentLobby || !currentSeat) return;
            
            const playerData = playerStates[currentSeat];
            if (!playerData) return;
            
            playerData.like = !playerData.like;
            playerData.dislike = false;
            
            // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
            if (socket) {
                socket.emit('update-player', {
                    lobbyId: currentLobby.id,
                    seat: currentSeat,
                    like: playerData.like,
                    dislike: playerData.dislike
                });
            }
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´
            createPlayerCircles();
            
            // Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡
            if (playerData.like) {
                setTimeout(() => {
                    if (playerStates[currentSeat]) {
                        playerStates[currentSeat].like = false;
                        
                        if (socket) {
                            socket.emit('update-player', {
                                lobbyId: currentLobby.id,
                                seat: currentSeat,
                                like: false,
                                dislike: false
                            });
                        }
                        
                        createPlayerCircles();
                    }
                }, 3000);
            }
        }
        
        function toggleDislike() {
            if (!currentLobby || !currentSeat) return;
            
            const playerData = playerStates[currentSeat];
            if (!playerData) return;
            
            playerData.dislike = !playerData.dislike;
            playerData.like = false;
            
            // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
            if (socket) {
                socket.emit('update-player', {
                    lobbyId: currentLobby.id,
                    seat: currentSeat,
                    like: false,
                    dislike: playerData.dislike
                });
            }
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´
            createPlayerCircles();
            
            // Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡
            if (playerData.dislike) {
                setTimeout(() => {
                    if (playerStates[currentSeat]) {
                        playerStates[currentSeat].dislike = false;
                        
                        if (socket) {
                            socket.emit('update-player', {
                                lobbyId: currentLobby.id,
                                seat: currentSeat,
                                like: false,
                                dislike: false
                            });
                        }
                        
                        createPlayerCircles();
                    }
                }, 3000);
            }
        }
        
        function toggleMic() {
            if (!currentLobby || !currentSeat) return;
            
            const playerData = playerStates[currentSeat];
            if (!playerData) return;
            
            userMicOn = !userMicOn;
            playerData.mic = userMicOn;
            
            // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
            if (socket) {
                socket.emit('update-player', {
                    lobbyId: currentLobby.id,
                    seat: currentSeat,
                    mic: userMicOn
                });
            }
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ú©Ù…Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ†
            const micBtn = document.getElementById('micButton');
            if (userMicOn) {
                micBtn.classList.add('active');
                
                if (socket) {
                    socket.emit('send-chat', {
                        lobbyId: currentLobby.id,
                        message: `${userName} Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø§ Ø±ÙˆØ´Ù† Ú©Ø±Ø¯`,
                        isSystem: true
                    });
                }
            } else {
                micBtn.classList.remove('active');
                
                if (socket) {
                    socket.emit('send-chat', {
                        lobbyId: currentLobby.id,
                        message: `${userName} Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø§ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯`,
                        isSystem: true
                    });
                }
            }
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´
            createPlayerCircles();
        }
        
        // ==================== Ø³ÛŒØ³ØªÙ… ÙˆÛŒØ¯ÛŒÙˆÚ†Øª ====================
        async function startVideoChat() {
            try {
                // Ù†Ù…Ø§ÛŒØ´ ÙˆÛŒØ¯ÛŒÙˆÚ†Øª
                document.getElementById('videoChatContainer').style.display = 'block';
                
                // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ùˆ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ†
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                setupLocalVideo();
                
                // Ø´Ø±ÙˆØ¹ ØªÙ…Ø§Ø³ Ø¨Ø§ Ø³Ø§ÛŒØ± Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†
                if (currentLobby && currentLobby.players) {
                    Object.values(currentLobby.players).forEach(player => {
                        if (player.userId !== currentUser) {
                            startVideoCall(player.userId);
                        }
                    });
                }
                
                console.log('ğŸ¥ ÙˆÛŒØ¯ÛŒÙˆÚ†Øª Ø´Ø±ÙˆØ¹ Ø´Ø¯');
                
            } catch (err) {
                console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ†:', err);
                showSystemMessage('Ù„Ø·ÙØ§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ùˆ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯', 'error');
            }
        }
        
        function setupLocalVideo() {
            const videoGrid = document.getElementById('videoGrid');
            
            // Ø­Ø°Ù ÙˆÛŒØ¯ÛŒÙˆÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ Ø®ÙˆØ¯Ù…Ø§Ù†
            const existingVideo = document.getElementById('video-local');
            if (existingVideo) existingVideo.remove();
            
            // Ø§ÛŒØ¬Ø§Ø¯ ÙˆÛŒØ¯ÛŒÙˆÛŒ Ù…Ø­Ù„ÛŒ
            const videoItem = document.createElement('div');
            videoItem.className = 'video-item video-local';
            videoItem.id = 'video-local';
            
            const video = document.createElement('video');
            video.autoplay = true;
            video.muted = true;
            video.srcObject = localStream;
            
            const videoName = document.createElement('div');
            videoName.className = 'video-name';
            videoName.textContent = `${userName} (Ø´Ù…Ø§)`;
            
            videoItem.appendChild(video);
            videoItem.appendChild(videoName);
            videoGrid.appendChild(videoItem);
        }
        
        async function startVideoCall(userId) {
            if (!peer || !localStream) return;
            
            console.log('ğŸ“ Ø´Ø±ÙˆØ¹ ØªÙ…Ø§Ø³ ÙˆÛŒØ¯ÛŒÙˆÛŒÛŒ Ø¨Ø§:', userId);
            
            try {
                const call = peer.call(userId, localStream);
                peerConnections[userId] = call;
                
                call.on('stream', (remoteStream) => {
                    console.log('ğŸ¥ Ø¯Ø±ÛŒØ§ÙØª stream Ø§Ø²:', userId);
                    addVideoStream(userId, remoteStream);
                });
                
                call.on('close', () => {
                    console.log('ğŸ“ ØªÙ…Ø§Ø³ Ø¨Ø³ØªÙ‡ Ø´Ø¯ Ø¨Ø§:', userId);
                    removeVideoStream(userId);
                    delete peerConnections[userId];
                });
                
                call.on('error', (err) => {
                    console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙ…Ø§Ø³ Ø¨Ø§', userId, ':', err);
                });
                
            } catch (err) {
                console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ØªÙ…Ø§Ø³:', err);
            }
        }
        
        async function handleVideoOffer(offer, fromUserId) {
            console.log('ğŸ“¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ offer Ø§Ø²:', fromUserId);
            
            if (!localStream) {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                    setupLocalVideo();
                } catch (err) {
                    console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ†:', err);
                    return;
                }
            }
            
            if (!peer) {
                console.error('âŒ PeerJS Ø¢Ù…Ø§Ø¯Ù‡ Ù†ÛŒØ³Øª');
                return;
            }
            
            try {
                const call = peer.call(fromUserId, localStream);
                peerConnections[fromUserId] = call;
                
                call.on('stream', (remoteStream) => {
                    console.log('ğŸ¥ Ø¯Ø±ÛŒØ§ÙØª stream Ø§Ø²:', fromUserId);
                    addVideoStream(fromUserId, remoteStream);
                });
                
                call.on('close', () => {
                    console.log('ğŸ“ ØªÙ…Ø§Ø³ Ø¨Ø³ØªÙ‡ Ø´Ø¯ Ø¨Ø§:', fromUserId);
                    removeVideoStream(fromUserId);
                    delete peerConnections[fromUserId];
                });
                
            } catch (err) {
                console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ø³Ø® Ø¨Ù‡ offer:', err);
            }
        }
        
        function handleVideoAnswer(answer, fromUserId) {
            console.log('ğŸ“¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ answer Ø§Ø²:', fromUserId);
            // Ø§ÛŒÙ†Ø¬Ø§ ØªÙˆØ³Ø· PeerJS Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆØ¯
        }
        
        function handleICECandidate(candidate, fromUserId) {
            console.log('â„ï¸ Ù¾Ø±Ø¯Ø§Ø²Ø´ ICE candidate Ø§Ø²:', fromUserId);
            // Ø§ÛŒÙ†Ø¬Ø§ ØªÙˆØ³Ø· PeerJS Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆØ¯
        }
        
        function addVideoStream(userId, stream) {
            const videoGrid = document.getElementById('videoGrid');
            
            // Ø­Ø°Ù ÙˆÛŒØ¯ÛŒÙˆÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
            const existingVideo = document.getElementById(`video-${userId}`);
            if (existingVideo) existingVideo.remove();
            
            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±
            let playerName = 'Ú©Ø§Ø±Ø¨Ø±';
            if (currentLobby && currentLobby.players) {
                Object.values(currentLobby.players).forEach(player => {
                    if (player.userId === userId) {
                        playerName = player.name;
                    }
                });
            }
            
            // Ø§ÛŒØ¬Ø§Ø¯ ÙˆÛŒØ¯ÛŒÙˆÛŒ Ø¬Ø¯ÛŒØ¯
            const videoItem = document.createElement('div');
            videoItem.className = 'video-item';
            videoItem.id = `video-${userId}`;
            
            const video = document.createElement('video');
            video.autoplay = true;
            video.srcObject = stream;
            
            const videoName = document.createElement('div');
            videoName.className = 'video-name';
            videoName.textContent = playerName;
            
            videoItem.appendChild(video);
            videoItem.appendChild(videoName);
            videoGrid.appendChild(videoItem);
        }
        
        function removeVideoStream(userId) {
            const videoElement = document.getElementById(`video-${userId}`);
            if (videoElement) {
                videoElement.remove();
            }
        }
        
        // ==================== Ø³ÛŒØ³ØªÙ… Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ====================
        function openProfileModal() {
            document.getElementById('profileModal').style.display = 'block';
            document.getElementById('avatar1').classList.remove('selected');
            document.getElementById('avatar2').classList.remove('selected');
            document.getElementById(currentAvatar).classList.add('selected');
            document.getElementById('currentUserName').textContent = userName;
            document.getElementById('userNameInput').value = '';
        }
        
        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }
        
        function switchProfileTab(tabName) {
            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.profile-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'avatars') {
                document.querySelector('.profile-tab:nth-child(1)').classList.add('active');
                document.getElementById('avatarsTab').classList.add('active');
            } else {
                document.querySelector('.profile-tab:nth-child(2)').classList.add('active');
                document.getElementById('buyTab').classList.add('active');
            }
        }
        
        function selectAvatar(avatarId) {
            document.getElementById('avatar1').classList.remove('selected');
            document.getElementById('avatar2').classList.remove('selected');
            document.getElementById(avatarId).classList.add('selected');
            currentAvatar = avatarId;
            localStorage.setItem('mafiaUserAvatar', currentAvatar);
            updateMainProfile();
            
            // Ø§Ú¯Ø± Ø¯Ø± Ù„Ø§Ø¨ÛŒ Ù‡Ø³ØªÛŒÙ…ØŒ Ø¢ÙˆØ§ØªØ§Ø± Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ² Ú©Ù†
            if (currentLobby && currentSeat && playerStates[currentSeat]) {
                playerStates[currentSeat].avatar = currentAvatar;
                
                if (socket) {
                    socket.emit('update-player', {
                        lobbyId: currentLobby.id,
                        seat: currentSeat,
                        avatar: currentAvatar
                    });
                }
                
                createPlayerCircles();
            }
        }
        
        function saveUserName() {
            const newName = document.getElementById('userNameInput').value.trim();
            
            if (!newName) {
                showSystemMessage('Ù„Ø·ÙØ§ Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            if (newName.length < 2 || newName.length > 20) {
                showSystemMessage('Ù†Ø§Ù… Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û² ØªØ§ Û²Û° Ø­Ø±Ù Ø¨Ø§Ø´Ø¯', 'error');
                return;
            }
            
            userName = newName;
            localStorage.setItem('mafiaUserName', userName);
            updateMainProfile();
            document.getElementById('currentUserName').textContent = userName;
            
            // Ø§Ú¯Ø± Ø¯Ø± Ù„Ø§Ø¨ÛŒ Ù‡Ø³ØªÛŒÙ…ØŒ Ù†Ø§Ù… Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ² Ú©Ù†
            if (currentLobby && currentSeat && playerStates[currentSeat]) {
                playerStates[currentSeat].name = userName;
                
                if (socket) {
                    socket.emit('update-player', {
                        lobbyId: currentLobby.id,
                        seat: currentSeat,
                        name: userName
                    });
                }
                
                createPlayerCircles();
            }
            
            showSystemMessage('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯', 'success');
        }
        
        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ ====================
        window.onclick = function(event) {
            const profileModal = document.getElementById('profileModal');
            if (event.target === profileModal) {
                profileModal.style.display = 'none';
            }
            
            const lobbyModal = document.getElementById('lobbyModal');
            if (event.target === lobbyModal) {
                lobbyModal.style.display = 'none';
            }
            
            const passwordPopup = document.getElementById('passwordPopup');
            if (event.target === passwordPopup) {
                passwordPopup.style.display = 'none';
                pendingPasswordLobby = null;
            }
        };
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById('profileModal').style.display === 'block') {
                    closeProfileModal();
                } else if (document.getElementById('lobbyModal').style.display === 'block') {
                    closeLobbyModal();
                } else if (document.getElementById('lobby-page').style.display === 'block') {
                    closeLobby();
                } else if (document.getElementById('friendly-hall-page').style.display === 'block') {
                    goBackToGame();
                }
                
                document.getElementById('passwordPopup').style.display = 'none';
            }
            
            if (e.key === 'Enter' && document.getElementById('chatInput') && 
                document.activeElement === document.getElementById('chatInput')) {
                sendChatMessage();
            }
            
            if (e.key === 'Enter' && document.getElementById('passwordInput') && 
                document.activeElement === document.getElementById('passwordInput')) {
                submitPassword();
            }
        });
        
        // ==================== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ====================
        window.onload = function() {
            console.log('ğŸš€ ØµÙØ­Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø³Øª...');
            loadUserData();
        };
    </script>
</body>
</html>